name: Update master sources from latest.jar (filtered)

on:
  push:
    branches: [ "main" ]
    paths:
      - "hytale/versions/latest.jar"
      - "hytale/tools/**"
      - ".github/workflows/update.yml"

  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: hytale-master-update
  cancel-in-progress: true

jobs:
  update-master:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"

      - name: Confirm
        run: |
          java -version
          javac -version

      - name: Verify
        run: |
          echo "Listing hytale/tools:"
          ls -la hytale/tools || true

          test -f hytale/tools/vineflower.jar
          test -f hytale/tools/vineflower.properties
          test -f hytale/tools/filter.txt

      - name: Compute
        id: jarinfo
        run: |
          set -euo pipefail

          JAR="hytale/versions/latest.jar"
          test -f "$JAR"

          SHA=$(sha256sum "$JAR" | awk '{print $1}')
          SHA12=${SHA:0:12}
          SIZE=$(stat -c%s "$JAR")

          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "sha12=$SHA12" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT

      - name: Debug
        run: |
          set -euo pipefail

          echo "Jar file:"
          ls -la hytale/versions/latest.jar

          echo "Top entries:"
          jar tf hytale/versions/latest.jar | head -n 60

          echo "Class count:"
          jar tf hytale/versions/latest.jar | grep -E '\.class$' | wc -l 

          echo "Example class paths:"
          jar tf hytale/versions/latest.jar | grep -E '\.class$' | head -n 25 || true

      - name: Reset
        run: |
          rm -rf hytale/main
          mkdir -p hytale/main/meta
          mkdir -p hytale/main/src
          mkdir -p hytale/main/resources

      - name: Filter
        shell: bash
        run: |
          set -euo pipefail

          JAR="hytale/versions/latest.jar"
          FILTER="hytale/tools/filter.txt"

          rm -rf tmp_extract tmp_filtered
          mkdir -p tmp_extract tmp_filtered

          unzip -q "$JAR" -d tmp_extract

          # collect allow/deny patterns
          mapfile -t ALLOW < <(grep -E '^\+\s+' "$FILTER" | sed -E 's/^\+\s+//' || true)
          mapfile -t DENY  < <(grep -E '^\-\s+' "$FILTER" | sed -E 's/^\-\s+//' || true)

          echo "Allow patterns: ${#ALLOW[@]}"
          echo "Deny patterns : ${#DENY[@]}"

          # enable ** glob support in bash
          shopt -s globstar nullglob dotglob

          should_include() {
            local rel="$1"

            # If allow list exists, must match at least one allow
            if [ "${#ALLOW[@]}" -gt 0 ]; then
              local ok=0
              for pat in "${ALLOW[@]}"; do
                if [[ "$rel" == $pat ]]; then
                  ok=1
                  break
                fi
              done
              [ "$ok" -eq 1 ] || return 1
            fi

            # Deny always wins
            for pat in "${DENY[@]}"; do
              if [[ "$rel" == $pat ]]; then
                return 1
              fi
            done

            return 0
          }

          included=0
          skipped=0

          while IFS= read -r -d '' entry; do
            rel="${entry#tmp_extract/}"

            if should_include "$rel"; then
              if [ -d "$entry" ]; then
                mkdir -p "tmp_filtered/$rel"
              else
                mkdir -p "tmp_filtered/$(dirname "$rel")"
                cp -p "$entry" "tmp_filtered/$rel"
              fi
              included=$((included+1))
            else
              skipped=$((skipped+1))
            fi
          done < <(find tmp_extract -mindepth 1 -print0)

          echo "Included entries: $included"
          echo "Skipped entries : $skipped"

          rm -f filtered.jar
          (cd tmp_filtered && zip -qr ../filtered.jar .)
          echo "filtered.jar size:"
          ls -lah filtered.jar

          echo "filtered.jar class count:"
          CLASS_COUNT=$(jar tf filtered.jar | grep -E '\.class$' | wc -l)
          echo "$CLASS_COUNT"

          echo "filtered.jar example classes:"
          jar tf filtered.jar | grep -E '\.class$' | head -n 20 || true

          if [ "$CLASS_COUNT" -eq 0 ]; then
            echo "ERROR: filtered.jar contains 0 class files. Filter rules didn't match."
            exit 1
          fi

          echo "Filtered jar size:"
          ls -la filtered.jar

          echo "Filtered jar top entries:"
          jar tf filtered.jar | head -n 60

          echo "Filtered jar class count:"
          CLASS_COUNT=$(jar tf filtered.jar | grep -E '\.class$' | wc -l)
          echo "$CLASS_COUNT"

          if [ "$CLASS_COUNT" -eq 0 ]; then
            echo "ERROR: filtered.jar contains 0 class files. Fix filter rules."
            exit 1
          fi


      - name: Rewrite
        shell: bash
        run: |
          set -euo pipefail

          rm -rf tmp_rewrite
          mkdir -p tmp_rewrite/in tmp_rewrite/out

          unzip -q filtered.jar -d tmp_rewrite/in

          # enable ** globbing
          shopt -s globstar nullglob dotglob

          HAS_CLASSES_DIR=0
          HAS_FILES_DIR=0

          [ -d tmp_rewrite/in/classes ] && HAS_CLASSES_DIR=1
          [ -d tmp_rewrite/in/files ]   && HAS_FILES_DIR=1

          if [ "$HAS_CLASSES_DIR" -eq 1 ] || [ "$HAS_FILES_DIR" -eq 1 ]; then
            echo "Detected launcher layout (classes/ + files/). Flattening..."

            # Move bytecode to root so packages become com/... directly
            if [ -d tmp_rewrite/in/classes ]; then
              rsync -a tmp_rewrite/in/classes/ tmp_rewrite/out/
            fi

            # Move resources to root too
            if [ -d tmp_rewrite/in/files ]; then
              rsync -a tmp_rewrite/in/files/ tmp_rewrite/out/
            fi

            # Preserve META-INF if exists at root
            if [ -d tmp_rewrite/in/META-INF ]; then
              rsync -a tmp_rewrite/in/META-INF/ tmp_rewrite/out/META-INF/
            fi

            # Preserve module-info.class if at root
            if [ -f tmp_rewrite/in/module-info.class ]; then
              cp -p tmp_rewrite/in/module-info.class tmp_rewrite/out/module-info.class
            fi
          else
            echo "Detected normal jar layout (packages at root). Keeping as-is..."
            rsync -a tmp_rewrite/in/ tmp_rewrite/out/
          fi

          rm -f filtered.jar
          (cd tmp_rewrite/out && jar cf ../../filtered.jar .)

          echo "Rewritten filtered.jar sanity:"
          echo "  class count: $(jar tf filtered.jar | grep -E '\.class$' | wc -l)"
          echo "  top entries:"
          jar tf filtered.jar | head -n 40
          echo "  first class:"
          jar tf filtered.jar | grep -E '\.class$' | head -n 5 || true


      - name: Extract
        run: |
          set -euo pipefail

          rm -rf tmp_filtered_extract
          mkdir -p tmp_filtered_extract
          unzip -q filtered.jar -d tmp_filtered_extract

          rsync -a --delete \
            --exclude='*.class' \
            --exclude='META-INF/*.SF' \
            --exclude='META-INF/*.RSA' \
            --exclude='META-INF/*.DSA' \
            tmp_filtered_extract/ \
            hytale/main/resources/


      - name: Decompile
        run: |
          set -euo pipefail

          test -f filtered.jar

          java -jar hytale/tools/vineflower.jar \
            -log=INFO \
            -inde     \
            -rsy=1 \
            -dgs=1 \
            -asc=1 \
            -nns=1 \
            filtered.jar \
            hytale/main/src

          echo "Master src summary:"
          find hytale/main/src -maxdepth 3 -type f | head -n 50
          echo "Java file count:"
          find hytale/main/src -type f -name '*.java' | wc -l

          # Remove META-INF from src tree if it appears
          rm -rf hytale/main/src/META-INF || true

          


      - name: Write
        run: |
          set -euo pipefail

          echo "${{ steps.jarinfo.outputs.sha }}" > hytale/main/meta/jar_sha256.txt
          echo "${{ steps.jarinfo.outputs.sha12 }}" > hytale/main/meta/jar_sha256_12.txt
          echo "${{ steps.jarinfo.outputs.size }}" > hytale/main/meta/jar_size_bytes.txt
          date -u +"%Y-%m-%dT%H:%M:%SZ" > hytale/main/meta/build_time_utc.txt

          echo "vineflower=hytale/tools/vineflower.jar" > hytale/main/meta/decompiler.txt
          cp hytale/tools/vineflower.properties hytale/main/meta/vineflower.properties
          cp hytale/tools/filter.txt hytale/main/meta/filter.txt


      - name: Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push (if changed)
        run: |
          git add hytale/main

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update master sources (${{ steps.jarinfo.outputs.sha12 }})"
          git push
